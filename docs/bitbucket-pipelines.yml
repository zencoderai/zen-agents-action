image: atlassian/default-image:5

definitions:
  steps:
    - step: &run-zen-agent-base
        name: Run Zencoder Agent
        script:
          - cd ..
          - echo "Downloading zencoder..."
          - VERSION=${VERSION:-latest}
          - BASE_URL="https://storage.googleapis.com/zencoder-public/zencoder/linux-amd64/$VERSION"
          - |
            curl -fsSL -o zencoder "$BASE_URL/zencoder" || {
              echo "Error: Failed to download zencoder binary" >&2
              exit 1
            }
          - |
            if [ ! -s zencoder ]; then
              echo "Error: Downloaded file is empty or missing" >&2
              exit 1
            fi
          - echo "Downloading checksum..."
          - |
            curl -fsSL -o zencoder.sha256 "$BASE_URL/zencoder.sha256" || {
              echo "Error: Failed to download checksum file" >&2
              exit 1
            }
          - echo "Verifying integrity..."
          - |
            echo "$(cat zencoder.sha256)  zencoder" | sha256sum -c - || {
              echo "Error: Checksum verification failed" >&2
              exit 1
            }
          - chmod +x zencoder
          - echo "Successfully installed and verified zencoder"
          - export CLIENT_ID="${ZENCODER_CLIENT_ID}"
          - export CLIENT_SECRET="${ZENCODER_CLIENT_SECRET}"
          - export BITBUCKET_TOKEN="${ZENCODER_BITBUCKET_TOKEN}"
          - echo "Running Zen Agent..."
          - ./zencoder --base-path "${BITBUCKET_CLONE_DIR}" --agent "${agent}" --prompt "${prompt}"
    
    - step: &run-zen-agent-pr
        name: Run Zencoder Agent - PR Review
        script:
          - |
            echo "Checking PR author using git..."
            PR_AUTHOR=$(git log -1 --pretty=format:'%an' HEAD)
            echo "PR Author: $PR_AUTHOR"
            if [[ "$PR_AUTHOR" =~ (bitbucket-pipelines) ]]; then
              echo "Skipping execution - PR created by bot: $PR_AUTHOR"
              exit 0
            fi
          - cd ..
          - echo "Downloading zencoder..."
          - VERSION=${VERSION:-latest}
          - BASE_URL="https://storage.googleapis.com/zencoder-public/zencoder/linux-amd64/$VERSION"
          - |
            curl -fsSL -o zencoder "$BASE_URL/zencoder" || {
              echo "Error: Failed to download zencoder binary" >&2
              exit 1
            }
          - |
            if [ ! -s zencoder ]; then
              echo "Error: Downloaded file is empty or missing" >&2
              exit 1
            fi
          - echo "Downloading checksum..."
          - |
            curl -fsSL -o zencoder.sha256 "$BASE_URL/zencoder.sha256" || {
              echo "Error: Failed to download checksum file" >&2
              exit 1
            }
          - echo "Verifying integrity..."
          - |
            echo "$(cat zencoder.sha256)  zencoder" | sha256sum -c - || {
              echo "Error: Checksum verification failed" >&2
              exit 1
            }
          - chmod +x zencoder
          - echo "Successfully installed and verified zencoder"
          - export CLIENT_ID="${ZENCODER_CLIENT_ID}"
          - export CLIENT_SECRET="${ZENCODER_CLIENT_SECRET}"
          - export BITBUCKET_TOKEN="${ZENCODER_BITBUCKET_TOKEN}"
          - |
            prompt="Please review the pull request with number $BITBUCKET_PR_ID and add comment to it. Please address only the serious issues, not the minor ones. If you didn't find any serious issues, please write 'Looks good to me!'."
            agent=""
          - echo "Running Zen Agent for PR review..."
          - ./zencoder --base-path "${BITBUCKET_CLONE_DIR}" --agent "${agent}" --prompt "${prompt}"

pipelines:
  custom:
    zencoder-agent:
      - variables:
          - name: prompt
            description: "The input prompt for the Agent"
            default: ""
          - name: agent
            description: "Alias of the agent to run (will run default agent if not provided)"
            default: ""
      - step: *run-zen-agent-base
    
  pull-requests:
    '**':
      - step: *run-zen-agent-pr
